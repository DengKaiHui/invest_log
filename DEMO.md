# 🎬 功能演示

## 完整使用流程演示

### 第一步：安装和启动

```bash
# 1. 安装依赖
npm install

# 2. 启动后端服务（终端1）
npm start

# 你会看到：
# 🚀 股票价格服务已启动
# 📡 服务地址: http://localhost:3001
# ⏱  缓存时间: 30 分钟
# 🔄 自动刷新: 每5分钟检查过期缓存
```

```bash
# 3. 启动前端服务（终端2 - 新开）
python3 -m http.server 8000

# 访问: http://localhost:8000/index.html
```

---

### 第二步：测试后端服务

```bash
# 新开终端3，运行测试
npm test

# 输出示例：
# ============================================================
# 🧪 股票价格服务测试开始
# ============================================================
# 
# 📡 测试 1: 健康检查
# ✓ 服务状态: running
#   运行时间: 120秒
#   缓存数量: 0
# 
# 📈 测试 2: 获取单个股票价格 (NVDA)
# 正在获取 NVDA 的价格...
# ✓ NVDA 价格: $485.32
#   缓存状态: 新获取
# 
# 📊 测试 3: 批量获取股票价格
# ✓ 批量获取成功
#   NVDA: $485.32 (缓存)
#   AAPL: $195.71
#   TSLA: $238.45
# 
# 🔄 测试 4: 强制刷新价格
# ✓ 刷新成功
#   NVDA: $485.50
# 
# 💾 测试 5: 查看缓存状态
# ✓ 缓存有效期: 30分钟
#   缓存项数量: 3
#   - NVDA: $485.50 (0分30秒前, 有效)
#   - AAPL: $195.71 (1分15秒前, 有效)
#   - TSLA: $238.45 (1分15秒前, 有效)
# 
# ============================================================
# ✅ 所有测试完成
# ============================================================
```

---

### 第三步：使用 Web 界面

#### 1. 添加投资记录

在"记一笔"卡片：
```
资产名称: NVDA
交易日期: 2024-01-15
总金额: 10000
单价: 200
```
点击"提交"

#### 2. 查看持仓盈亏

在"持仓盈亏"卡片会自动显示：
```
名称/代码    市值/数量      现价/成本      持仓盈亏
NVDA        $24,266.00    $485.32       +$14,266.00
            50.00         $200.00       +142.66%
```

#### 3. 刷新价格

点击"刷新价格"按钮：
- 首次点击：从 Yahoo Finance 获取最新价格（约2秒）
- 30分钟内再次点击：立即返回缓存数据（< 0.1秒）
- 30分钟后点击：自动更新最新价格

---

### 第四步：API 调用演示

#### 使用 cURL

```bash
# 1. 健康检查
curl http://localhost:3001/api/health

# 输出：
# {
#   "success": true,
#   "status": "running",
#   "uptime": 300,
#   "cacheSize": 3,
#   "message": "服务运行正常"
# }
```

```bash
# 2. 获取单个股票价格
curl http://localhost:3001/api/price/NVDA

# 输出：
# {
#   "success": true,
#   "symbol": "NVDA",
#   "price": 485.32,
#   "cached": true,
#   "lastUpdate": 1701234567890
# }
```

```bash
# 3. 批量获取价格
curl -X POST http://localhost:3001/api/prices \
  -H "Content-Type: application/json" \
  -d '{"symbols":["NVDA","AAPL","TSLA"],"force":false}'

# 输出：
# {
#   "success": true,
#   "results": {
#     "NVDA": {
#       "price": 485.32,
#       "cached": true,
#       "lastUpdate": 1701234567890
#     },
#     "AAPL": {
#       "price": 195.71,
#       "cached": true,
#       "lastUpdate": 1701234567890
#     },
#     "TSLA": {
#       "price": 238.45,
#       "cached": true,
#       "lastUpdate": 1701234567890
#     }
#   }
# }
```

```bash
# 4. 强制刷新价格
curl -X POST http://localhost:3001/api/refresh \
  -H "Content-Type: application/json" \
  -d '{"symbols":["NVDA"]}'

# 输出：
# {
#   "success": true,
#   "results": {
#     "NVDA": {
#       "price": 485.50,
#       "lastUpdate": 1701234600000
#     }
#   },
#   "message": "价格已刷新"
# }
```

```bash
# 5. 查看缓存状态
curl http://localhost:3001/api/cache/status

# 输出：
# {
#   "success": true,
#   "cacheExpiry": 30,
#   "items": [
#     {
#       "symbol": "NVDA",
#       "price": 485.50,
#       "lastUpdate": 1701234600000,
#       "age": 120,
#       "valid": true
#     }
#   ]
# }
```

```bash
# 6. 清除缓存
curl -X DELETE http://localhost:3001/api/cache

# 输出：
# {
#   "success": true,
#   "message": "已清除 3 个缓存项"
# }
```

---

### 第五步：观察缓存工作流程

#### 时间线演示

```
00:00 - 启动服务
        后端服务启动，缓存为空

00:10 - 用户点击"刷新价格"
        ↓
        前端调用 /api/refresh
        ↓
        后端从 Yahoo Finance 获取 NVDA, AAPL, TSLA
        ↓
        缓存更新，返回价格数据
        ↓
        用户看到最新价格（耗时约2秒）

00:15 - 用户再次点击"刷新价格"
        ↓
        前端调用 /api/refresh
        ↓
        后端发现缓存有效（只过了5分钟）
        ↓
        直接返回缓存数据
        ↓
        用户立即看到价格（< 0.1秒）

05:00 - 后台定时任务触发
        ↓
        检查所有缓存项
        ↓
        发现 NVDA, AAPL, TSLA 都还在有效期内
        ↓
        无需刷新

30:15 - 用户点击"刷新价格"
        ↓
        前端调用 /api/refresh
        ↓
        后端发现缓存已过期（超过30分钟）
        ↓
        从 Yahoo Finance 获取最新价格
        ↓
        更新缓存
        ↓
        返回新价格（耗时约2秒）

35:00 - 后台定时任务触发
        ↓
        检查所有缓存项
        ↓
        发现缓存刚刚更新过
        ↓
        无需刷新
```

---

### 第六步：性能对比

#### 场景1：首次获取（无缓存）

**之前（直接调用 Yahoo Finance）**
```
用户点击刷新 → 逐个获取3个股票
NVDA: 500ms
AAPL: 500ms  
TSLA: 500ms
总耗时: 1500ms
```

**现在（使用后端服务）**
```
用户点击刷新 → 批量获取3个股票
NVDA: 500ms
AAPL: 500ms (并发)
TSLA: 500ms (并发)
总耗时: 500ms（并发优化）
```

#### 场景2：30分钟内再次获取

**之前（无缓存）**
```
用户点击刷新 → 重复请求
总耗时: 1500ms
API调用: 3次
```

**现在（有缓存）**
```
用户点击刷新 → 返回缓存
总耗时: < 10ms ⚡
API调用: 0次 ✅
```

**性能提升：150倍！** 🚀

---

### 第七步：错误处理演示

#### 测试无效股票代码

```bash
curl http://localhost:3001/api/price/INVALID123

# 输出：
# {
#   "success": false,
#   "message": "无法获取 INVALID123 的价格"
# }
```

#### 测试后端服务未启动

访问前端，点击"刷新价格"：
```
❌ 价格更新失败，请确保后端服务已启动
```

控制台：
```
✗ 获取价格失败: Failed to fetch
提示：请运行 npm start 启动后端服务
```

---

### 第八步：监控和维护

#### 实时监控服务状态

```bash
# 每5秒检查一次
watch -n 5 'curl -s http://localhost:3001/api/health | python3 -m json.tool'
```

#### 查看缓存详情

```bash
# 美化输出缓存状态
curl -s http://localhost:3001/api/cache/status | python3 -m json.tool
```

#### 后端日志输出

```
正在获取 NVDA 的价格...
✓ NVDA 价格: $485.32

↻ 使用缓存: AAPL = $195.71

⏰ 定时刷新: TSLA
正在获取 TSLA 的价格...
✓ TSLA 价格: $238.50
```

---

## 🎯 实用技巧

### 技巧1：开发模式

使用 watch 模式，代码修改自动重启：
```bash
npm run dev
```

### 技巧2：快速清理

重置所有数据：
```bash
# 清除后端缓存
curl -X DELETE http://localhost:3001/api/cache

# 清除前端数据（浏览器控制台）
localStorage.clear()
location.reload()
```

### 技巧3：性能测试

测试缓存效果：
```bash
# 首次请求（无缓存）
time curl http://localhost:3001/api/price/NVDA

# 再次请求（有缓存）
time curl http://localhost:3001/api/price/NVDA
```

### 技巧4：批量导入

如果有多个持仓，建议批量添加后一次性刷新价格，而不是每添加一个就刷新一次。

---

## 📊 使用统计

假设你有10个持仓，每天查看5次：

**之前（无缓存）**
- API 调用: 10 × 5 = 50次/天
- 总等待时间: 50 × 0.5秒 = 25秒/天
- 被限流风险: 高

**现在（有缓存）**
- API 调用: 10 × 1 = 10次/天（缓存30分钟）
- 总等待时间: 10 × 0.5 + 40 × 0.01 = 5.4秒/天
- 被限流风险: 低

**节省：80%的API调用，78%的等待时间！** 🎉

---

## 🌟 最佳实践

1. **首次使用**：点击"刷新价格"获取最新数据
2. **日常查看**：直接打开即可，自动使用缓存
3. **重要决策**：手动刷新确保数据最新
4. **后台运行**：保持后端服务运行，享受自动更新

---

**演示完成！开始使用吧！** 🚀
